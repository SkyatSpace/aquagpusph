<?xml version="1.0" ?>

<!-- portal.xml
A pair of infinite plane portals with 2 functions:
  - The particles tresspasing the out portal will be teleported to the in portal
  - The particles close to the out portal will interact with the particles close
    to the in portal

It should be remarked that the portal is unidirectional, i.e. the particles
close to the in portal will not be affected at all.

To use this preset just simply include this file and set the variables:
  - portal_in_r: In portal infinite plane position
  - portal_out_r: Out portal infinite plane position
  - portal_n: portal infinite planes normal

A particles is considered out of the portal when
const float dist = dot(r[i] - portal_out_r, portal_out_n) > 0,
and it will be reinjected at the in portal as
r[i] = portal_in_r + dist * portal_out_n.

In case several portals should be included (for instance in periodic cases), the
variables commented above should be modified 2 times during each time step. For
instance:

<Include file="portal.xml" prefix="left_"/>
<Include file="portal.xml" prefix="right_"/>
<Tools>
    <Tool action="insert" before="left_cfd portal_pre mirror" type="set_scalar" name="left_portal_out_r" in="portal_out_r" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal_pre mirror" type="set_scalar" name="left_portal_out_n" in="portal_out_n" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal_pre mirror" type="set_scalar" name="left_portal_in_r" in="portal_in_r" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal_pre mirror" type="set_scalar" name="left_portal_in_n" in="portal_in_n" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal mirror" type="set_scalar" name="left_portal_out_r" in="portal_out_r" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal mirror" type="set_scalar" name="left_portal_out_n" in="portal_out_n" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal mirror" type="set_scalar" name="left_portal_in_r" in="portal_in_r" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal mirror" type="set_scalar" name="left_portal_in_n" in="portal_in_n" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal teleport" type="set_scalar" name="left_portal_out_r" in="portal_out_r" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal teleport" type="set_scalar" name="left_portal_out_n" in="portal_out_n" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal teleport" type="set_scalar" name="left_portal_in_r" in="portal_in_r" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="left_cfd portal teleport" type="set_scalar" name="left_portal_in_n" in="portal_in_n" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal_pre mirror" type="set_scalar" name="right_portal_out_r" in="portal_out_r" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal_pre mirror" type="set_scalar" name="right_portal_out_n" in="portal_out_n" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal_pre mirror" type="set_scalar" name="right_portal_in_r" in="portal_in_r" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal_pre mirror" type="set_scalar" name="right_portal_in_n" in="portal_in_n" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal mirror" type="set_scalar" name="right_portal_out_r" in="portal_out_r" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal mirror" type="set_scalar" name="right_portal_out_n" in="portal_out_n" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal mirror" type="set_scalar" name="right_portal_in_r" in="portal_in_r" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal mirror" type="set_scalar" name="right_portal_in_n" in="portal_in_n" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal teleport" type="set_scalar" name="right_portal_out_r" in="portal_out_r" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal teleport" type="set_scalar" name="right_portal_out_n" in="portal_out_n" value="1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal teleport" type="set_scalar" name="right_portal_in_r" in="portal_in_r" value="-1.0, 0.0, 0.0, 0.0"/>
    <Tool action="insert" before="right_cfd portal teleport" type="set_scalar" name="right_portal_in_n" in="portal_in_n" value="1.0, 0.0, 0.0, 0.0"/>
</Tools>

delta-SPH will not be affected at all! 
-->

<sphInput>
    <Variables>
        <Variable name="portal_in_r" type="vec" value="0.0, 0.0, 0.0, 0.0" />
        <Variable name="portal_out_r" type="vec" value="0.0, 0.0, 0.0, 0.0" />
        <Variable name="portal_n" type="vec" value="0.0, 0.0, 0.0, 0.0" />
        <!-- Helper flag to identify the particles close to the out portal -->
        <Variable name="imirrored" type="int*" length="N" />
        <!-- Helper variable to restore the icell after the mirroring (to avoid
        that truncation errors may destroy the linklist) -->
        <Variable name="icell_backup" type="unsigned int*" length="n_radix" />
    </Variables>

    <Tools>
        <!-- 1st stage: Omega computation
             ============================
        -->
        <!-- We must start mirroring particles (and marking them). -->
        <Tool action="insert" before="Omega" name="cfd portal_pre icell backup" type="copy" in="icell" out="icell_backup"/>
        <Tool action="insert" before="Omega" name="cfd portal_pre mirror" type="kernel" entry_point="mirror" path="@RESOURCES_OUTPUT_DIR@/Scripts/cfd/variable_h/Boundary/Portal/Mirror.cl"/>
        <!-- Now we can compute the effect of the in portal particles -->
        <Tool action="insert" before="Omega" name="cfd portal_pre Omega" type="kernel" path="@RESOURCES_OUTPUT_DIR@/Scripts/cfd/variable_h/Boundary/Portal/Omega.cl"/>
        <!-- We must unmirror the particles (even the ones which should be
        teleported) in order to dont missconsider the particles in subsequent
        interactions computations -->
        <Tool action="insert" before="Omega" name="cfd portal_pre unmirror" type="kernel" entry_point="unmirror" path="@RESOURCES_OUTPUT_DIR@/Scripts/cfd/Boundary/Portal/Mirror.cl"/>
        <Tool action="insert" before="Omega" name="cfd portal_pre icell restore" type="copy" in="icell_backup" out="icell"/>

        <!-- 2nd stage: Particle interactions
             ================================
        -->
        <!-- We must start mirroring particles (and marking them). -->
        <Tool action="insert" before="Interactions" name="cfd portal icell backup" type="copy" in="icell" out="icell_backup"/>
        <Tool action="insert" before="Interactions" name="cfd portal mirror" type="kernel" entry_point="mirror" path="@RESOURCES_OUTPUT_DIR@/Scripts/cfd/variable_h/Boundary/Portal/Mirror.cl"/>
        <!-- Now we can compute the effect of the in portal particles -->
        <Tool action="insert" before="Interactions" name="cfd portal Shepard" type="kernel" path="@RESOURCES_OUTPUT_DIR@/Scripts/cfd/variable_h/Boundary/Portal/Shepard.cl"/>
        <Tool action="insert" before="Interactions" name="cfd portal interactions" type="kernel" path="@RESOURCES_OUTPUT_DIR@/Scripts/cfd/variable_h/Boundary/Portal/Interactions.cl"/>
        <!-- We must unmirror the particles (even the ones which should be
        teleported) in order to dont missconsider the particles in subsequent
        interactions computations -->
        <Tool action="insert" before="Interactions" name="cfd portal unmirror" type="kernel" entry_point="unmirror" path="@RESOURCES_OUTPUT_DIR@/Scripts/cfd/Boundary/Portal/Mirror.cl"/>
        <Tool action="insert" before="Interactions" name="cfd portal icell restore" type="copy" in="icell_backup" out="icell"/>

        <!-- 3rd stage: Particle teleporting
             ===============================
        -->
        <!-- Finally we should teleport the particles tresspassing the out
        portal. -->
        <Tool action="insert" before="Corrector" name="cfd portal teleport" type="kernel" entry_point="teleport" path="@RESOURCES_OUTPUT_DIR@/Scripts/cfd/Boundary/Portal/Mirror.cl"/>
    </Tools>
</sphInput>
